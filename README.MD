# Motion and Object Detection Project

## Описание проекта

Этот проект предназначен для двух сценариев работы:
1. **Анализ готовых видеофайлов** (например, с камер видеонаблюдения) для обнаружения движения и распознавания объектов.
2. **Анализ потоков в реальном времени** через RTSP с камер видеонаблюдения.
2. **Анализ потоков в реальном времени c вектором движения** через RTSP с камер видеонаблюдения.

Для распознавания объектов используется модель YOLOv8. Проект умеет обнаруживать движение, определять заданные классы объектов (например, `person`, `car`, `dog`), сохранять кадры с обнаруженными объектами и вести лог в CSV.

### Основные возможности
- **Три режима работы**: локальные видеофайлы и RTSP-потоки (с вектором и без вектора движения).
- **Обнаружение движения**: разность кадров и контурный анализ.
- **Распознавание объектов**: YOLOv8 (`yolov8s.pt` или `yolov8n.pt`).
- **Сохранение результатов**:
  - Кадры — в `motion_frames` или `rtsp_motion_frames`.
  - CSV-логи (`motions_log.csv` или `rtsp_motions_log.csv`).
- **Многопоточность**: `ThreadPoolExecutor` для обработки нескольких видео или потоков.
- **Гибкая настройка**: классы объектов, чувствительность движения, количество потоков и т.д.

### Как теперь задавать зоны (важно)

1. Откроется одно окно ZONE_SETUP.
2. Для каждой камеры по очереди:
3. Сначала START, потом FINISH.
#### Управление:
1. `W/S/A/D` — двигаем прямоугольник.
2. `I/K` — увеличить/уменьшить высоту.
3. `L/J` — увеличить/уменьшить ширину.
4. `R` — сбросить (40% по центру).
5. `Enter` — подтвердить прямоугольник.
6. `Esc` — пропустить (не рекомендую).
7. После настройки идёт краткий предпросмотр (по 2 сек на камеру) — зеленый START, красный FINISH

#### В режиме выполнения:
1. `SPACE` — переключение глобального режима Idle ⇄ Primed (в Idle триггеры не срабатывают).
2. `A` — вкл/выкл звуковых уведомлений.
3. `W` — вкл/выкл показа кадров (окно остаётся одним, но при OFF показывает «Display OFF…» и новые кадры не выводит).
4. В окне `VIEWER` вверху слева теперь рисуется строка статуса: Mode, Alarm, Display.
5. Внизу расширенная подсказка по горячим клавишам.

## Требования

### Системные
- Windows 10+ (Linux/macOS поддерживаются с адаптацией).
- Python 3.7+.
- 8+ ГБ ОЗУ.
- CPU с 4+ ядрами.
- (Опционально) GPU с CUDA для ускорения YOLO.

### Зависимости
В `requirements.txt`:
- `opencv-python`
- `numpy`
- `tqdm`
- `ultralytics`
- `simpleaudio` (для звука)

## Установка

1. Склонируйте или распакуйте проект, чтобы в папке были файлы:
   - `motion_detector.py` — анализ готовых видео;
   - `rtsp_motion_detector.py` — анализ RTSP-потоков;
   - `start.cmd` — общий лаунчер;
   - `run_motion.cmd`, `rtsp_run_motion.cmd` — скрипты запуска для каждого режима;
   - модели YOLO (`yolov8s.pt`, `yolov8n.pt`).

2. Для режима RTSP создайте `cameras.json`:
```json
{
  "cam1": "rtsp://user:pass@ip:port/stream1",
  "cam2": "rtsp://user:pass@ip:port/stream2"
}
```

## Использование

### Запуск через `start.cmd`
1. Дважды щёлкните по `start.cmd`.
2. Выберите режим:
   - **1** — анализ готовых видео (запустится `run_motion.cmd` → `motion_detector.py`).
   - **2** — анализ RTSP-потоков (запустится `rtsp_run_motion.cmd` → `rtsp_motion_detector.py`).
3. Скрипт создаст `venv`, установит зависимости и запустит выбранный режим.

### Результаты
- CSV (`motions_log.csv` или `rtsp_motions_log.csv`).
- Папка с кадрами (`motion_frames` или `rtsp_motion_frames`).
- Лог-файлы (`motion_debug.log`).

## Структура проекта
```
.
├── start.cmd                # Лаунчер для выбора режима
├── run_motion.cmd            # Запуск анализа готовых видео
├── motion_detector.py        # Анализ готовых видео
├── rtsp_run_motion.cmd       # Запуск анализа RTSP-потоков
├── rtsp_motion_detector.py   # Анализ RTSP-потоков
├── cameras.json              # Список камер для RTSP
├── motion_frames/            # Кадры из видеофайлов
├── rtsp_motion_frames/       # Кадры из потоков
├── motions_log.csv           # CSV для видеофайлов
├── rtsp_motions_log.csv      # CSV для потоков
├── yolov8s.pt / yolov8n.pt    # Модели YOLOv8
└── requirements.txt
```

## Настройка
Параметры изменяются в начале соответствующего `.py` файла:
```python
SENSITIVITY = 25
MIN_AREA = 800
MAX_THREADS = 4
YOLO_MODEL = "yolov8n.pt"
CONF_THRESHOLD = 0.7
TARGET_CLASSES = ["person", "cat", "dog"]
```
